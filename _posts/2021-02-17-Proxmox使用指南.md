---
title: 'Proxmox使用指南'
date: 2021-02-17
permalink: /posts/2021/02/17/ProxmoxIntro/
tags:
  - Linux
---



## 基础介绍

目前公司采用pve来做虚拟化，主要运行的虚拟机包括

> ceph（gateway 和 monitor 节点），vpn（来源于外部连接的客户端），consul（gateway 和 worker 节点），dhcp（用于办公室的网络分配），dns ，forward-proxy，golinks，hdfs，k8s（master 和 slave-bastion 节点），kafka，logstash，lvs，minio(gateway)，mysql（主备结构），netboot，nexus，onlogin-ldap，postgresql，rabbitmq，syslog，teleport，tidb，vault，windows

## Proxmox系统的安装与使用



## 虚拟机的增删改查

### Option 1 pvesh

pvesh是直接调用pve API的一种方法，通常包括 get/delete/ls/usage/set五种方法，其中get/delege/set分别对应GET/DELETE/PUT三种HTTP请求方式

使用以下参数控制输出格式

> - --human-readable \<boolean\>
> - --noborder
> - --noheader
> - --output-format \<jsonnet \| json-pretty \| text \| yaml\>
> - --quiet \<boolean\>

这里展示最常用的vm列表查询和vm状态查询API

```shell
# 查询proxmox-001上所有存在的虚拟机（包括已关闭的虚拟机）
sudo pvesh get /cluster/resources

# 查询proxmox-001中vmid为9012的服务器当前状态
sudo pvesh get /nodes/proxmox-001/qemu/9012/status/current
```

### Option 2 Web Console

在页面上可以看到虚拟机的状态，同时支持进行虚拟机删除操作，要比proxmox-tool delete好用

## 虚拟机集群的使用

### 跨网段通信的建立

在proxmox vm的初期使用中，通常使用同一个vlan来存放所有的vm以及proxmox物理节点，但是处于安全及隔离考虑，后期需要使用不同vlan来划分不同用途的vm和proxmox物理节点，对于一个公司通常需要开放下面三个vlan：

- VLAN-A: proxmox 物理节点
- VLAN-B: dev环境的vm节点
- VLAN-C: prod环境的vm节点

此时，为了保证vm间及vm与物理节点之间的网络通联，就需要更新proxmox物理节点配置文件。I同时在proxmox物理节点连接的交换机上打开trunk模式（以支持交换机上同一个interface下多个vlan节点的数据连通）

实际维护过程通常分为下面几步：

1. 更新Proxmox Cluster Config

   在Proxmox的[Cluster Config](https://github.com/ponyai/common/blob/master/proxmox/utils/generated/cluster-configs.yaml)中为cluster添加新Vlan的配置，参考[PR-130346](https://github.com/ponyai/common/pull/140346)中为Beijing，Yizhuang开启Vlan的设置

2. 更新已有VM的Vlan配置

   在前面所描述的VM配置文件中，有IP和vlan_name的设定，在未开启multivlan时，一个cluster中的vm会公用一个vlan，例如：

   - 若Region A原有vm vlan: 10.9.40.0/24，Region B原有vm vlan: 10.20.42.0/24

3. 在DNS中更新VM的新IP

   在第二步中更新VM IP后，维护中，就会将旧有IP下的VM移动到新IP。为避免维护后VM无法访问，所以需要在维护前准备好DNS配置的更新。

4. 开始维护

   维护过程主要是更新服务器节点上相关配置，需要在以下文件中，更新节点的IP和Vlan

   - `/etc/pve/corosync.conf`
   - `/etc/network/interfaces`
   - `/etc/hosts`
   - `/etc/issue`

5. 在ipmi web console中检查服务器无异常文件、媒体挂载后，重启服务器

   重启后检查`/etc/network/interfaces`情况，如未更新，需再次重启

6. 更新Proxmox Cluster网桥配置

   ```shell
   [TBC]
   ```

   